using System.Collections.Generic;
using UnityEngine;
using Unity.MLAgents;
using Unity.MLAgents.Sensors;

public class FishAgentExploit : Agent, IFish
{
    private EnvironmentManager environment;
    public FishMovement movement;
    public FishSensors sensors;
    private WallSensors wallSensors;
    private ProximitySensor vision;

    private HarpoonSensor harpoonSensor;

    public void Start()
    {
        wallSensors = sensors.wallSensors;
        vision = sensors.visionSensor;
        harpoonSensor = sensors.harpoonSensor;
        EnvironmentManager.ActiveFishes.Add(gameObject);
    }

    public override void CollectObservations(VectorSensor sensor)
    {
        // current rotation
        sensor.AddObservation(transform.localEulerAngles.z / 360.0f);

        // wall sensors
        sensor.AddObservation(wallSensors.HitPositions.Contains(WallPosition.LEFT));
        sensor.AddObservation(wallSensors.HitPositions.Contains(WallPosition.MIDDLE));
        sensor.AddObservation(wallSensors.HitPositions.Contains(WallPosition.RIGHT));

        // closest ship
        Vector3? closestShip = GetClosestShip();
        sensor.AddObservation(closestShip == null);
        float distX = 1f, distY = 1f;
        if (closestShip != null)
        {
            distX = ((closestShip.GetValueOrDefault().x - transform.position.x) / 26f) / 2f + 0.5f;
            distY = ((closestShip.GetValueOrDefault().y - transform.position.y) / 26f) / 2f + 0.5f;
        }
        sensor.AddObservation(distX);
        sensor.AddObservation(distY);

        // closest ship
        Vector3? closestHarpoon = GetClosestHarpoon();
        sensor.AddObservation(closestHarpoon == null);
        distX = 1f; distY = 1f;
        if (closestHarpoon != null)
        {
            distX = ((closestHarpoon.GetValueOrDefault().x - transform.position.x) / 26f) / 2f + 0.5f;
            distY = ((closestHarpoon.GetValueOrDefault().y - transform.position.y) / 26f) / 2f + 0.5f;
        }
        sensor.AddObservation(distX);
        sensor.AddObservation(distY);

        AddReward(1f);
    }

    public override void OnActionReceived(float[] vectorAction)
    {
        float throttle = vectorAction[0];
        float rotate = vectorAction[1];

        movement.Speed = vectorAction[0] / 2 + 0.5f;
        movement.Rotate(vectorAction[1] * 5);
    }

    Vector2? GetClosestShip()
    {
        Vector2? closest = null;
        float minDistance = float.MaxValue;
        foreach (var ship in vision.SeenShips.Values)
        {
            var distance = Vector2.Distance(ship, transform.position);
            if (distance < minDistance)
            {
                closest = ship;
                minDistance = distance;
            }
        }
        return closest;
    }

    Vector2? GetClosestHarpoon()
    {
        Vector2? closest = null;
        float minDistance = float.MaxValue;
        foreach (var harpoon in harpoonSensor.SeenHarpoons)
        {
            if (harpoon == null)
                continue;

            var distance = Vector2.Distance(harpoon.position, transform.position);
            if (distance < minDistance)
            {
                closest = harpoon.position;
                minDistance = distance;
            }
        }
        return closest;
    }

    public void OnNotifyFish(Vector2 position)
    {
        // ignore
    }

    public void Kill()
    {
        GameObject.FindWithTag("GameManager").GetComponent<EnvironmentManager>().RemoveFish(gameObject);
        Destroy(gameObject);
    }
}
