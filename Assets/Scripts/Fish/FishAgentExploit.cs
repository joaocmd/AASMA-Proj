using System.Collections.Generic;
using UnityEngine;
using Unity.MLAgents;
using Unity.MLAgents.Sensors;

public class FishAgentExploit : Agent, IFish
{
    private EnvironmentManager environment;
    public FishMovement movement;
    public FishSensors sensors;
    private WallSensors wallSensors;
    private ProximitySensor vision;

    public void Start()
    {
        wallSensors = sensors.wallSensors;
        vision = sensors.visionSensor;
        EnvironmentManager.ActiveFishes.Add(gameObject);
    }

    public override void CollectObservations(VectorSensor sensor)
    {
        // wall sensors
        sensor.AddObservation(wallSensors.HitPositions.Contains(WallPosition.LEFT));
        sensor.AddObservation(wallSensors.HitPositions.Contains(WallPosition.MIDDLE));
        sensor.AddObservation(wallSensors.HitPositions.Contains(WallPosition.RIGHT));

        // closest ship
        Vector3? closestShip = GetClosestShip();
        sensor.AddObservation(closestShip == null);
        sensor.AddObservation(closestShip ?? Vector3.zero);
        AddReward(1f);
    }

    public override void OnActionReceived(float[] vectorAction)
    {
        float throttle = vectorAction[0];
        float rotate = vectorAction[1];

        movement.Speed = vectorAction[0] / 2 + 0.5f;
        movement.Rotate(vectorAction[1] * 5);
    }

    Vector2? GetClosestShip()
    {
        Vector2? closest = null;
        float minDistance = float.MaxValue;
        foreach (var ship in vision.SeenShips.Values)
        {
            var distance = Vector2.Distance(ship, transform.position);
            if (distance < minDistance)
            {
                closest = ship;
                minDistance = distance;
            }
        }
        return closest;
    }

    public void OnNotifyFish(Vector2 position)
    {
        // ignore
    }

    public void Kill()
    {
        GameObject.FindWithTag("GameManager").GetComponent<EnvironmentManager>().RemoveFish(gameObject);
        Destroy(gameObject);
    }
}
